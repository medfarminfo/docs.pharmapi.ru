# Отличия от оригинального протокола :id=differencies


## Методы `register` и `confirm_code`  :id=register

!>  По состоянию на апрель 2020 года нет ни одной программы, где бы использовалась регистрация карты на кассе в аптеке. На вызовы `register` и `confirm_code` сервер на данный момент отвечает фиксированным отрицательным ответом.


## Указание `pharmacy_id` вместе с `pos_id`  :id=pharmacy_id

Во всех запросах где присутствует параметр `pos_id` очень желательно указывать код аптеки (`pharmacy_id`) - это снизит требования к частоте передачи данных об аптеках. Сервер, в этом случае, будет указывать тот же параметр `pharmacy_id` в ответах.

При этом заполнение поля `pos_id` всё равно является обязательным (для возможности одновременного расчета скидки по двум разным чекам на двух разных кассах одной аптеки).

В случае если переданная в запросе комбинация значений `pos_id` и `pharmacy_id`  не соответствует ранее переданным данным по аптекам (т.е. указанное значение `pos_id` не присутствовало в списке аптек совсем, или же было подчинено другой аптеке), то значение `pharmacy_id` имеет приоритет.


## Указание `program` в ответе на `get_discount` :id=program-in-get-discount

Для облегчения привязки скидок к дисконтным программам в учетной системе аптеки при расчёте скидки сервер указывает по какой программе рассчитана скидка (соответствует полю `code` из ответа `get_programs`):

```json
{
  "pos_id": "1-234-567",
  "card_number": "1234567890050",
  "orders": [
    {
      "any_data": "row1",
      "barcode": "1111111111116",
      "count": 3,
      "description": "Наименование препарата",
      "discount": 466.2,
      "error_code": 0,
      "message": "Снижение цены рассчитано",
      "transaction": "e70774d1434b4acb905a81164db67c3c",
      "type": "percent",
      "value": 1864.8,
      "value_per_item": 621.6,
      "program": "test" //                   <<<--- новое поле
    }
  ],
  "status": "success",
  "error_code": 0,
  "message": "Снижение цены рассчитано"
}
```


## Множественное число в имени поля (`programs`) в ответе на `get_programs` :id=programs-in-get-programs

!> Применяется только начиная с [версии 1.1](connect.md#api-version-1-1). В более ранних версиях по-прежнему используется единственое число (`program`).

В ответе на запрос `get_programs` используется множественное число для имени поля (`programs`):

```json
{
  "programs": [
    {
      "code": "test",
      "name": "Тестовая программа для отладки протокола"
    }
  ],
  "status": "success",
  "error_code": 0,
  "message": "Список проектов сформирован"
}
```


## Передача информации об аптеках :id=pharmacies

В оригинальном протоколе передача данных об аптеках сети выполняется через отдельный FTP-сервер. Однако для работы с PharmApi.ru сведения об аптеках можно передавать прямо на основной сервер любым из двух способов.


### JSON-метод `update_pharmacies` :id=update_pharmacies

Можно передавать все аптеки сразу (удобно для разовых загрузок), или по одной (или партиями) по мере изменения данных в основной учетной системе аптечной сети. 

Пример запроса:

```json
{
  "update_mode":"replace",
  "pharmacies":
  [
    { // минимально необходимые сведения об аптеке
      "id":"121",
      "address":"Москва, Центральная улица, дом 1",
      "pos_ids": [ "121-1", "121-2", "121-11" ],
    },  
    { // полный набор поддерживаемых полей
      "id":"123",
      "brand":"Супер-Аптека",
      "region":"Москва",
      "city":"Москва",
      "address":"Москва, Центральный переулок, дом 11",
      "gps":"55.55, 37.37",
      "work_time":"пт-сб 08-20",
      "phones":"8 (800) 000-00-00",
      "pos_ids": [ "123-1", "123-2", "123-11" ],
      "disabled":false
    },
    {...}, ...
  ]
}
```

* **update_mode** - режим обновления данных, допустимые значения: `merge` или `replace`, _обязательное поле_:
    * *merge* - "режим слияния": данные по переданным аптекам будут записаны поверх предыдущих данных тех же аптек, при этом данные по ранее переданным аптекам (не указанных в данном запросе) будут оставлены без изменения;
    * *replace* - "режим перезаписи": данные по переданным аптекам будут записаны поверх предыдущих данных тех же аптек, при этом данные по ранее переданным аптекам (не указанных в данном запросе) будут очищены (т.е. равноценно удалению всех остальных аптек, кроме переданных).
* **pharmacies** - массив данных по аптекам:
  * **id** - код (идентификатор) аптеки, _обязательное поле_;
  * **brand** - бренд / торговая марка аптеки (название, написанное на вывеске)
  * **region** - регион (субъект РФ), где расположена аптека
  * **city** - город (населенный пункт), где расположена аптека
  * **address** - полный адрес аптеки (включая регион и город), _обязательное поле_;
  * **gps** - GPS-координаты аптеки, широта и долгота в долях градусов, разделитель запятая, дробная часть отделяется точкой (например: `55.779532, 37.585421`)
  * **work_time** - часы работы аптеки
  * **phones** - контактные телефоны аптеки ("публичные" - для покупателей, чтобы показывать на общедоступном сайте
  * **pos_ids** - массив идентификаторов POS-терминалов, относящихся к данной аптеке.
  * **disabled** - признак выключения/удаления аптеки:
    * `false` (по умолчанию) - аптека активна (не отключена) и обслуживает покупателей
    * `true` - аптека выключена и не обслуживает покупателей
   
Все перечисленные выше поля имеют строковый тип (string) за исключением поля `disabled`, которое имеет логический тип (boolean).

Допустимо наличие других полей со сведениями об аптеке (они будут проигнорированы сервером).
   
В случае, если в запросах помимо `pos_id` в запросах также посылается `pharmacy_id`, то заполнение массива `pos_ids` необязательно.

В случае, если в файле есть аптеки с одинаковым (повторяющимся) `id` - будут использованы данные последней из них.

Если в файле один и тот же `pos_id` встретится в нескольких аптеках - он будет "привязан" к последней из них.


### XML-метод `pl` :id=xml_pl

В целях совместимости со старым протоколом допускается передача данных по аптекам с помощью передачи xml-файла определённой структуры ("обычный" PL-файл).

Файл может быть отправлен двумя способами:

  * как отправка (submit) html-формы с приложенным файлом: с указанием стандартных `multipart/form-data` и `boundary=...` в http-заголовке `Content-Type`;
  * в теле (body) запроса, как и остальные методы протокола, в этом случае http-заголовок `Content-Type` должен содержать значение `application/xml` или `text/xml`.
  
!> **Важно!** В случае работы по endpoint c urlencode (/v1.0-encoded/) при отправке аптек "как приложенного файла" urlencode не используется!

Пример файла, аналогичного описанному выше JSON:

```xml
<?xml version="1.0" encoding="utf-8"?> 
<PHARMACIES>
    <VERSION>1.1</VERSION>
    <CHAINCODE>12345</CHAINCODE>
    <COUNT>2</COUNT>
    <PHARMACY> <!-- минимальный набор данных об аптеке -->
        <CODE>121</CODE>
        <ADDRESS>Москва, Центральная улица, дом 1</ADDRESS>
        <POSES>
            <POS> <CODE>121-1</CODE> </POS>
            <POS> <CODE>121-2</CODE> </POS>
            <POS> <CODE>121-11</CODE> </POS>
        </POSES>
    </PHARMACY>
    <PHARMACY> <!-- полный набор данных об аптеке -->
        <CODE>123</CODE>
        <BRAND>Супер-аптека</BRAND>
        <REGION>Москва</REGION>
        <CITY>Москва</CITY>
        <ADDRESS>Москва, Центральный переулок, дом 11</ADDRESS>
        <GPS>55.55, 37.37</GPS>
        <WORKTIME>пт-сб 08-20</WORKTIME>
        <PHONES>8 (800) 000-00-00</PHONES>
        <POSES>
            <POS> <CODE>123-1</CODE> </POS>
            <POS> <CODE>123-2</CODE> </POS>
            <POS> <CODE>123-11</CODE> </POS>
        </POSES>
        <DISABLED>false</DISABLED>
    </PHARMACY>
  </PHARMACIES>
```


К файлу применимы все описанные в предыдущих разделах замечания касательно POS-кодов.

Допускается наличие любых других элементов/тегов  - они будут проигнорированы.

Если в вашем файле уже присутствуют какие-то другие полезные (но не указанные выше) поля, или же присутствуют с другим именем - сообщите нам, мы попробуем подстроиться под ваш формат файла.

При получении данного файла информация обо всех аптеках, которые были переданы ранее (и не переданы в текущем файле) будет аннулирована, т.е. передача PL-файла выполняется в режиме `update_mode="replace"` (в терминах метода `update_drugstores`).