# Метод `get_discount`

Один из двух основных методов, с помощью которого происходит продажа со скидкой.

Данный метод выполняет расчёт скидки по переданным позициям чека. Если продажа товара с такими условиями состоялась - необходимо вызвать [`confirm_purchase`](confirm_purchase.md) для фиксации факта продажи (подтверждения транзакции).

!> Вызов метода `confirm_purchase` возможен в течение 30 минут с момента вызова `get_discount`, после этого времени сервер будет возвращать сообщение об ошибке (подтверждение такой продажи необходимо производить через техподдержку, при этом в подтверждении мжет быть отказано если данная карта относится к лимитным тарифам и держатель карты уже "выбрал" лимит обратившись в другую аптеку).

## Запрос :id=request

Метод запроса: `POST`

Тело запроса:
```json
{
    "pos_id": "<pos_id>",
    "pharmacy_id": "<pharmacy_id>",
    "card_number": "<card_number>",
    "phone_number": "<phone_number>",
    "any_data": "<any_data>",
    "orders": [
        {
          "barcode": "<barcode_1>",
          "qr_code": "<qr_code_1>",
          "count": <count_1>,
          "price": <price_1>,
          "any_data": "<any_data_1>"
        },
        ...
    ]
}
```

Поля в запросе:

  * `pos_id` - обязательный, строковый (до 50 символов) \
Идентификатор кассового терминала (используется для идентификации аптеки в случае отсутствия параметра pharmacy_id)
  * `pharmacy_id` - необязательный но желательный (*[подробнее здесь](/like_changes#pharmacy_id)*), строковый (до 50 символов) \
Идентификатор аптеки, для которой необходимо получить список товарных позиций
  * `card_number` - обязательный (см. примечание ниже), строковый (до 50 символов) \
Номер дисконтной карты, предъявленной покупателем
  * `phone_number` - обязательный (см. примечание ниже), строковый (до 50 символов) \
Номер телефона покупателя (поддерживается не во всех дисконтных программах, подробности уточняйте при интеграции)
  * `any_data` - необязательный, строковый (до 100 символов) \
Любая строка, имеющая значения для кассового ПО (например внутренний идентификатор чека) - будет возвращена в неизменном виде в ответе
  * `orders` - массив объектов, содержащих перечень товарных позиций в чеке:
    * `barcode` - необязательный (см. примечание ниже), строковый (до 50 символов) \
Заводской штрихкод товарной позиции (чтобы рассчиталась скидка - должен совпадать с одним из значений barcode в ответе метода [`get_products`](get_products.md)
    * `qr_code` - необязательный, строковый \
Значение DataMatrix-кода на упаковке
    * `count` - обязательный, числовое \
Количество единиц товарной позиции в строке чека (количество потребительских упаковок)
    * `price` - обязательный, числовое с десятичными разрядами \
Розничная цена (в рублях) за единицу товарной позиции (за одну потребительскую упаковку), к которой будет применяться расчёт скидки
    * `any_data` - необязательный, строковый (до 100 символов) \
Любая строка, имеющая значения для кассового ПО (например внутренний идентификатор строки чека) - будет возвращена в неизменном виде в ответе

В запросе должно присутствовать ровно одно из двух полей: `card_number` или `phone_number`, иначе запрос считается некорректным и будет возвращена ошибка.

Значение поля `barcode` можно не указывать, если это "дополнительная" товарная позиция (пакетик, сувенир, ...), на которую заведомо не должно быть скидки - сервер вернёт эту товарную позицию в ответе в неизменом виде, даже не пытаясь рассчитать скидку.

## Ответ :id=response

```json
{
    "status": "<status>",
    "error_code": <error_code>,
    "message": "<message>",
    "description": "<description>",
    "pos_id": "<pos_id>",
    "pharmacy_id": "<pharmacy_id>",
    "card_number": "<card_number>",
    "phone_number": "<phone_number>",
    "any_data": "<any_data>",
    "orders": [
        {
          "any_data": "<any_data_1>",
          "barcode": "<barcode_1>",     
          "qr_code": "<qr_code_1>",     
          "count": <count_1>,
          "description": "<description_1>",
          "discount": <discount_1>,
          "error_code": <error_code_1>,
          "message": "<message_1>",
          "price": <price_1>,
          "program": "<program_1>",
          "program_name": "<program_name_1>",
          "transaction": <transaction_1>,   
          "type": "<type>"
          "value": <final_price_1>,
          "value_per_item": <average_price_1>, 
        },
        ...
    ]
}
```

Поля в ответе:

  * `status` - текстовое, одно из двух значений: `success` (успех) или `error` (ошибка)
  * `error_code` - числовое, код ошибки (`0` если скидка была успешно рассчитана хотя бы по одной из позиций)
  * `message` - текстовое, сообщение описывающее результат операции (необходимо показать на экране в определённых случаях)
  * `description` - текстовое, информационное сообщение для провизора (необходимо показать на экране)
  * `pos_id` - значение, которое было передано в запросе
  * `pharmacy_id` - значение, которое было передано в запросе
  * `card_number` - значение, которое было передано в запросе
  * `phone_number` - значение, которое было передано в запросе
  * `any_data` - значение, которое было передано в запросе
  * `orders` - массив объектов, с описанием скидок по каждой товарной позиции
    * `any_data` - значение, которое было передано в запросе
    * `barcode` - значение, которое было передано в запросе
    * `qr_code` - значение, которое было передано в запросе
    * `count` - значение, которое было передано в запросе
    * `description` - название (описание) товарной позиции (как его понял сервер по полю `barcode`, соответствует полю `description` из ответа метода [`get_products`](get_products.md))
    * `discount` - числовое (с десятичными разрядами), общая (суммарная) величина скидки по данной позиции чека в рублях
    * `error_code` - числовое, код ошибки (`0` если скидка была успешно рассчитана)
    * `message` - текстовое, сообщение описывающее результат расчета скидки по данной позиции (необходимо показать на экране в определённых случаях)
    * `price` - значение, которое было передано в запросе
    * `program` - текстовое, код программы (поле `code` из ответа метода [`get_programs`](get_programs.md)) согласно которой была рассчитана скидка по данной позиции
    * `program_name` - текстовое, наименование программы (поле `name` из ответа метода [`get_programs`](get_programs.md)) согласно которой была рассчитана скидка по данной позиции
    * `transaction` - текстовое, код для подверждения продажи со скидкой данной позиции методом [`confirm_purchase`](confirm_purchase.md)
    * `type` - текстовое, содержит информацию о применённом способе расчет скидки, возможные значения: `cash` (абсолютная скидка в рублях) или `percent` (скидка в процентах от исходной цены)
    * `value` - числовое (с десятичными разрядами), итоговая стоимость продажи данной позиции чека, рассчитана как `(price * count) - discount` 
    * `value_per_item` - числовое (с десятичными разрядами), итоговая стоимость продажи одной товарной позиции по данной позиции чека, рассчитана как `((price * count) - discount) / count` 

!> В некоторых дисконтных программах критически важно, чтобы подтверждались все позиции со скидкой (т.е. надо подтверждать коды `transaction` из всех строк `order` где они были), и при попытке "частичного" подтверждения (например только одной строки со скидкой из двух по которым рассчиталась скидка) методом `confirm_purchase` будет возвращена ошибка. Таким образом, если покупатель после расчета скидки изменил чек (отказался от части позиций) то необходимо повторно вызвать `get_discount` для повторного расчёта скидки и получения новых кодов подтверждения, и только после этого вызывать `confirm_purchase`.

Пример ответа:
```json
{
  "description": "Скидка может быть разной при каждом расчёте, предложите покупателю испытать судьбу добавив ещё один препарат.",
  "pos_id": "test-pos",
  "pharmacy_id": "test-pharmacy",
  "card_number": "1234567890050",
  "any_data": "f695bd58-a5c3-46b0-8c72-186ca1668ab4",
  "orders": [
    {
      "any_data": "test",
      "barcode": "1111111111116",
      "count": 2,

      "description": "Товар с кодом из двенадцати единиц и плюс (+) \"6\"",
      "discount": 444.44,
      "error_code": 0,
      "message": "Снижение цены рассчитано",
      "price": 1111.11,
      "program": "test",
      "program_name": "Тестовая программа для отладки протокола",
      "transaction": "367f43b339ad499a82250ac278ec8d53",
      "type": "percent",
      "value": 1777.78,
      "value_per_item": 888.89,
    }
  ],
  "status": "success",
  "error_code": 0,
  "message": "Товар с кодом из двенадцати единиц: Снижение цены рассчитано"
}
```

## Порядок интерпретации значений `error_code` :id=error_code

При анализе ответа сервера следует руководствоваться таким порядком проверок:

1. Если значение `error_code` верхнего уровня **не** равно нулю (т.е. запрос в целом неуспешный) - значит скидок "внутри" нет ни на одну позицию (при этом сами значения в orders могут присутствовать в неизменом виде, а могут вовсе отсутствовать - по ситуации).
  1. Необходимо **показать пользователю (провизору) сообщение из поля `message`** вернего уровня (обычно в модальном/выплывающем окне / popup).
  2. Также рекомендуется предпринять действия в зависимост от конкретного значения error_code:
    * `1` - CardNotFound: карта с указанным номером не найдена, её можно удалить из чека. Если номер вводился вручную (а не сканированием) - можно показать снова окно ввода номера для повторной попытки (возможно пользователь ошибся вводя цифры вручную и захочет потворить попытку).
    * `101` - CardDisabled: карта с указанным номером найдена, но недействительна (по разным причинам). Можно удалить карту из чека, при этом показывать повторно окно ввода номера нет необходимости - карта была введена верно, ошибки не было.
    * `4` - CouponAlreadyUsed: данная карта/купон является одноразовой и уже была использована (скидка по ней уже была предоставлена ранее). Можно удалить карту из чека.
    * `5` - PhoneNotFound: телефон не найден среди зарегистрированных для предоставления скидки (в случае если был передано phone_number в запросе и дисконтная программа поддерживает предоставление скидок по номеру телефона).
    * При любых других (ненулевых) значениях поля `error_code` верхнего уровня достаточно лишь показать пользователю сообщение из поля `message`, других автоматических действий делать не требуется.
2. Если значение `error_code` верхнего уровня равно нулю, и вы не передавали ни одной позиции в блоке `orders` запроса (и соответственно вернулся пустой блок `orders` в ответе) - значит карта успешно прошла проверку.
3. Если значение `error_code` верхнего уровня равно нулю и вы передавали какие-то позиции в блоке `orders` - значит ответ будет содержать то же самое количество позиций в блоке `orders`, и при этом как минимум одна позиция содержит успешно рассчитанную скидку (error_code позиции равен нулю). В этом случае:
  1. Необходимо вывести содержимое поля `description` верхнего уровня в предназначенное для этого "информационное" место на экране.
  2. Необходимо проверить все позиции из блока `orders` и применить в чеке скидку из тех позиций, где error_code == 0.
  3. Необходимо проверить все позиции из блока `order` и одно из двух:
     * вывести содержимое поля `message` из позиций имеющих `error_code` не равный нулю в соответствующей строке чека на экране 
     * вывести содержимое поля `message` верхнего уровня (оно будет содержать "собранное" сообщение для всех строк) в в модальном/выплывающем окне (popup)
  4. Можно применять подходящие (на усмотрение разработчика кассового ПО) автоматические действия согласно предопределенным значениям `error_code` на уровне строк:
     * `1` - UnknownBarcode: указанный штрихкод товарной позиции (`barcode`) не найден (не входит ни в одну известную дисконтную программу)
     * `101` - EmptyBarcode: у этой товарной позиции не был указан штрихкод, она была пропущена
     * `10` - NotInThisPharmacy: указанный штрихкод товарной позиции входит в дисконтную программу, не активную (не применимую) к данной аптеке
     * `3` - Overlimit: предельно допустимое количество уже было выкуплено, необходимо подождать некоторое время (до начала нового периода), в сообщении будет указана конкретная дата
     * `301` - Redeemed: предельно допустимое количество уже было выкуплено, больше скидка на данный препарат по данной карте предоставляться не будет.
     * Возможно появление других значений в поле `error_code`, помимо перечисленных выше.