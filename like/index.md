# PharmApi.ru: подключение по протоколу Астра-Зенека (Лайк-Фарма)

## История изменений документа

* Февраль 2020:
  * Добавлено отличие [4. Указание `program` в ответе на `get_discount`](#4-указание-program-в-ответе-на-get_discount)
  * Исправлена ошибка: метод `update_drugstores` это неверное имя метода, верное имя  [`update_pharmacies`](#передача-информации-об-аптеках-метод-update_pharmacies)
* Январь 2020:
  * Первоначальная версия документа.

## Общая информация

За основу взята оригинальная документация, опубликованная на [astrazeneca.like-pharma.com](https://astrazeneca.like-pharma.com/api/documentation/), из неё реализованы методы: 

  * register
  * confirm_code
  * get_discount
  * confirm_purchase
  * get_products
  * get_programs
  * cancel_purchase
  
Описание этих методов сюда не копируется, пожалуйста используйте исходный документ.

## Порядок подключения

  1. Имя сервера (hostname) выделяется каждому партнеру в начале интеграции;
  2. Тестовые значения `authorization-token` и `authorization-secret` выделяются каждому партнеру в начале интеграции;
  3. Боевые значения  `authorization-token` и `authorization-secret` выделяются каждому партнеру после успешного завершения интеграции, перед запуском проекта.


## Отличия от оригинального протокола

### 1. Кодировка данных

Каждый сервер имеет два endpoint-а для обмена данными: 

 * `https://{hostname}/api/v1.0/` - запросы и ответы передаются в теле запроса в JSON
 * `https://{hostname}/api/v1.0-encoded/` - запросы и ответы передаются в теле запроса в JSON, кодированном с помощью urlencode 

Использовать можно любой из двух endpoint-ов.


### 2. HTTPS

Обмен данными возможен только по протоколу HTTPS (обычный HTTP не поддерживается). Проверка сертификата сервера от клиента не требуется.

Обмен данными следует выполнять по hostname: использование IP-адреса не приветствуется, так как IP может меняться со временем.


### 3. Указание `pharmacy_id` вместе с `pos_id` 

Во всех запросах где присутствует параметр `pos_id` очень желательно указывать код аптеки (`pharmacy_id`) - это снизит требования к частоте передачи данных об аптеках. Сервер, в этом случае, будет указывать тот же параметр `pharmacy_id` в ответах.

При этом заполнение поля `pos_id` всё равно является обязательным (для возможности одновременного расчета скидки по двум разным чекам на двух разных кассах одной аптеки).

В случае если переданная в запросе комбинация значений `pos_id` и `pharmacy_id`  не соответствует ранее переданным данным по аптекам (т.е. указанное значение `pos_id` не присутствовало в списке аптек совсем, или же было подчинено другой аптеке), то значение `pharmacy_id` имеет приоритет.

### 4. Указание `program` в ответе на `get_discount`

Для облегчения привязки скидок к дисконтным программам в учетной системе аптеки при расчёте скидки сервер указывает по какой программе рассчитана скидка (соответствует полю `code` из ответа `get_programs`):

```json
{
  "pos_id": "1-234-567",
  "card_number": "1234567890050",
  "orders": [
    {
      "any_data": "row1",
      "barcode": "1111111111116",
      "count": 3,
      "description": "Наименование препарата",
      "discount": 466.2,
      "error_code": 0,
      "message": "Снижение цены рассчитано",
      "transaction": "e70774d1434b4acb905a81164db67c3c",
      "type": "percent",
      "value": 1864.8,
      "value_per_item": 621.6,
      "program": "test" //                   <<<--- новое поле
    }
  ],
  "status": "success",
  "error_code": 0,
  "message": "Снижение цены рассчитано"
}
```

## Дополнительные методы

Так как в оригинальном протоколе не реализован некоторый необходимый функционал, то созданы нижеследующие дополнительные методы.


### Передача информации об аптеках: метод `update_pharmacies`

Пример запроса:

```json
{
  "update_mode":"replace",
  "pharmacies":
  [
    { // минимально необходимые сведения об аптеке
      "id":"121",
      "address":"Москва, Центральная улица, дом 1",
      "pos_ids": [ "121-1", "121-2", "121-11" ],
    },  
    { // полный набор поддерживаемых полей
      "id":"123",
      "brand":"Супер-Аптека",
      "region":"Москва",
      "city":"Москва",
      "address":"Москва, Центральный переулок, дом 11",
      "gps":"55.55, 37.37",
      "work_time":"пт-сб 08-20",
      "phones":"8 (800) 000-00-00",
      "pos_ids": [ "123-1", "123-2", "123-11" ],
      "disabled":false
    },
    {...}, ...
  ]
}
```

* **update_mode** - режим обновления данных, допустимые значения: `merge` или `replace`, _обязательное поле_:
    * *merge* - "режим слияния": данные по переданным аптекам будут записаны поверх предыдущих данных тех же аптек, при этом данные по ранее переданным аптекам (не указанных в данном запросе) будут оставлены без изменения;
    * *replace* - "режим перезаписи": данные по переданным аптекам будут записаны поверх предыдущих данных тех же аптек, при этом данные по ранее переданным аптекам (не указанных в данном запросе) будут очищены (т.е. равноценно удалению всех остальных аптек, кроме переданных).
* **pharmacies** - массив данных по аптекам:
  * **id** - код (идентификатор) аптеки, _обязательное поле_;
  * **brand** - бренд / торговая марка аптеки (название, написанное на вывеске)
  * **region** - регион (субъект РФ), где расположена аптека
  * **city** - город (населенный пункт), где расположена аптека
  * **address** - полный адрес аптеки (включая регион и город), _обязательное поле_;
  * **gps** - GPS-координаты аптеки, широта и долгота в долях градусов, разделитель запятая, дробная часть отделяется точкой (например: `55.779532, 37.585421`)
  * **work_time** - часы работы аптеки
  * **phones** - контактные телефоны аптеки ("публичные" - для покупателей, чтобы показывать на общедоступном сайте
  * **pos_ids** - массив идентификаторов POS-терминалов, относящихся к данной аптеке.
  * **disabled** - признак выключения/удаления аптеки:
    * `false` (по умолчанию) - аптека активна (не отключена) и обслуживает покупателей
    * `true` - аптека выключена и не обслуживает покупателей
   
Все перечисленные выше поля имеют строковый тип (string) за исключением поля `disabled`, которое имеет логический тип (boolean).

Допустимо наличие других полей со сведениями об аптеке (они будут проигнорированы сервером).
   
В случае, если в запросах помимо `pos_id` в запросах также посылается `pharmacy_id`, то заполнение массива `pos_ids` необязательно.

В случае, если в файле есть аптеки с одинаковым (повторяющимся) `id` - будут использованы данные последней из них.

Если в файле один и тот же `pos_id` встретится в нескольких аптеках - он будет "привязан" к последней из них.


### Передача информации об аптеках в виде xml-файла "типа PL": метод `pl`

В целях совместимости со старым протоколом допускается передача данных по аптекам с помощью передачи xml-файла определённой структуры (PL-файл), однако передача должна выполняться по протоколу HTTPS (а не FTP).

Файл может быть отправлен двумя способами:

  * как отправка (submit) html-формы с приложенным файлом: с указанием стандартных `multipart/form-data` и `boundary=...` в http-заголовке `Content-Type`;
  * в теле (body) запроса, как и остальные методы протокола, в этом случае http-заголовок `Content-Type` должен содержать значение `application/xml` или `text/xml`.
  
**Важно!** В случае работы по endpoint c urlencode (/v1.0-encoded/) при отправке аптек "как приложенного файла" urlencode не используется!

Пример файла, аналогичного описанному выше JSON:

```xml
<?xml version="1.0" encoding="utf-8"?> 
<PHARMACIES>
    <VERSION>1.1</VERSION>
    <CHAINCODE>12345</CHAINCODE>
    <COUNT>2</COUNT>
    <PHARMACY> <!-- минимальный набор данных об аптеке -->
        <CODE>121</CODE>
        <ADDRESS>Москва, Центральная улица, дом 1</ADDRESS>
        <POSES>
            <POS> <CODE>121-1</CODE> </POS>
            <POS> <CODE>121-2</CODE> </POS>
            <POS> <CODE>121-11</CODE> </POS>
        </POSES>
    </PHARMACY>
    <PHARMACY> <!-- полный набор данных об аптеке -->
        <CODE>123</CODE>
        <BRAND>Супер-аптека</BRAND>
        <REGION>Москва</REGION>
        <CITY>Москва</CITY>
        <ADDRESS>Москва, Центральный переулок, дом 11</ADDRESS>
        <GPS>55.55, 37.37</GPS>
        <WORKTIME>пт-сб 08-20</WORKTIME>
        <PHONES>8 (800) 000-00-00</PHONES>
        <POSES>
            <POS> <CODE>123-1</CODE> </POS>
            <POS> <CODE>123-2</CODE> </POS>
            <POS> <CODE>123-11</CODE> </POS>
        </POSES>
        <DISABLED>false</DISABLED>
    </PHARMACY>
  </PHARMACIES>
```


К файлу применимы все описанные в предыдущих разделах замечания касательно POS-кодов.

Допускается наличие любых других элементов/тегов  - они будут проигнорированы.

Если в вашем файле уже присутствуют какие-то другие полезные (но не указанные выше) поля, или же присутствуют с другим именем - сообщите нам, мы попробуем подстроиться под ваш формат файла.

При получении данного файла информация обо всех аптеках, которые были переданы ранее (и не переданы в текущем файле) будет аннулирована, т.е. передача PL-файла выполняется в режиме `update_mode="replace"` (в терминах метода `update_drugstores`).